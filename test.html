<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Vision HW Helper — Mobile (v2)</title>
  <style>
    :root{--bg:#0b0b10;--panel:#10141b;--ink:#eef2f6;--muted:#a6b0c2;--acc:#4da3ff;--bad:#ff5d6c}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0b10,#0d1117);color:var(--ink);
         font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto}
    header{position:sticky;top:0;z-index:3;background:#0c1016;border-bottom:1px solid #1d2431;padding:14px 16px}
    h1{margin:0;font-size:18px}
    .wrap{max-width:720px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid #1d2431;border-radius:16px;overflow:hidden;box-shadow:0 8px 28px rgba(0,0,0,.35);margin-bottom:12px}
    .pad{padding:14px}
    label{display:block;margin:0 0 6px 2px;color:var(--muted);font-size:13px}
    input, select, textarea, button{font-size:16px}
    input[type="password"], textarea, select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #273246;background:#0d1117;color:var(--ink)}
    textarea{min-height:100px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 240px}
    .drop{border:1.5px dashed #2a3647;border-radius:14px;padding:14px;text-align:center;color:#b6c0d2;background:#0d1219}
    .drop.hover{border-color:var(--acc);background:#0f1622}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumbs img{height:80px;border-radius:10px;border:1px solid #263145}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;background:var(--acc);color:#08101b;font-weight:800}
    .btn.secondary{background:#182235;color:#c8d3e6;border:1px solid #263145}
    .btn:disabled{opacity:.6}
    .out{white-space:pre-wrap;background:#0a0e14;border-top:1px solid #1e2430;padding:14px;max-height:55vh;overflow:auto}
    .small{font-size:13px;color:var(--muted)}
    .switch{display:flex;align-items:center;gap:10px}
    .switch input{width:1.3em;height:1.3em}
    .warn{color:var(--bad)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#101826;border:1px solid #243043;color:#b9c6d8;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Vision HW Helper — Mobile (v2)</h1>
  </header>
  <div class="wrap">
    <div class="card">
      <div class="pad">
        <div class="row">
          <div>
            <label for="key">OpenAI API Key</label>
            <input id="key" type="password" placeholder="sk-..." autocomplete="off" inputmode="none" />
            <div class="switch" style="margin-top:8px">
              <input id="remember" type="checkbox" />
              <label for="remember" class="small">Remember key on this device (localStorage)</label>
            </div>
          </div>
          <div>
            <label for="model">Model</label>
            <select id="model">
              <!-- Vision models (no reasoning param) -->
              <option value="gpt-4o" selected>gpt-4o (vision)</option>
              <option value="gpt-4o-mini">gpt-4o-mini (vision, cheap)</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini (vision)</option>
              <!-- Reasoning-capable models -->
              <option value="o3-mini">o3-mini (reasoning + vision)</option>
              <option value="o4-mini">o4-mini (reasoning + vision)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="switch">
            <input id="reasoningToggle" type="checkbox" />
            <label for="reasoningToggle" class="small">Enable reasoning effort</label>
          </div>
          <div>
            <label for="effort" class="small">Reasoning effort</label>
            <select id="effort">
              <option value="low">low</option>
              <option value="medium" selected>medium</option>
              <option value="high">high</option>
            </select>
          </div>
        </div>

        <div style="margin-top:8px">
          <label for="prompt">Task</label>
          <textarea id="prompt" placeholder="Explain the steps and show reasoning."></textarea>
        </div>

        <div style="margin-top:10px">
          <label>Images</label>
          <div id="drop" class="drop">
            <div style="margin-bottom:8px">Tap to add photos or use camera</div>
            <input id="file" type="file" accept="image/*" capture="environment" multiple style="display:none" />
            <div class="actions" style="justify-content:center;margin-top:6px">
              <button class="btn secondary" id="pick">Choose Photos</button>
              <button class="btn secondary" id="camera">Open Camera</button>
              <button class="btn secondary" id="paste">Paste Clipboard</button>
            </div>
            <div id="thumbs" class="thumbs"></div>
          </div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn" id="run">Ask</button>
          <button class="btn secondary" id="clear">Clear</button>
          <span class="small" id="capNote"></span>
        </div>
      </div>
      <div id="out" class="out"></div>
    </div>

    <div class="card"><div class="pad small">
      ⚠️ Use this for learning, not for turning in AI-only homework. Your API key stays on device (unless you choose “Remember”).
    </div></div>
  </div>

  <script>
    const el = (id)=>document.getElementById(id);
    const key = el('key'), remember = el('remember'), model = el('model'),
          reasoningToggle = el('reasoningToggle'), effort = el('effort'),
          promptEl = el('prompt'), file = el('file'), pickBtn = el('pick'),
          cameraBtn = el('camera'), pasteBtn = el('paste'),
          thumbs = el('thumbs'), runBtn = el('run'), clearBtn = el('clear'),
          out = el('out'), capNote = el('capNote');

    // Known model capabilities
    const MODEL_CAPS = {
      'gpt-4o': {vision:true, reasoning:false},
      'gpt-4o-mini': {vision:true, reasoning:false},
      'gpt-4.1-mini': {vision:true, reasoning:false},
      'o3-mini': {vision:true, reasoning:true},
      'o4-mini': {vision:true, reasoning:true}
    };

    function refreshCaps(){
      const caps = MODEL_CAPS[model.value] || {vision:true, reasoning:false};
      reasoningToggle.disabled = !caps.reasoning;
      effort.disabled = !caps.reasoning;
      if (!caps.reasoning){ reasoningToggle.checked = false; }
      capNote.textContent = caps.reasoning
        ? 'Reasoning supported on this model.'
        : 'Reasoning not supported on this model (auto-disabled).';
    }
    model.addEventListener('change', refreshCaps);
    refreshCaps();

    // Persist key if user opts in
    try{
      const saved = localStorage.getItem('vh_key');
      if (saved){ key.value = saved; remember.checked = true; }
    }catch{}
    remember.addEventListener('change', ()=>{
      try{
        if (remember.checked) localStorage.setItem('vh_key', key.value.trim());
        else localStorage.removeItem('vh_key');
      }catch{}
    });
    key.addEventListener('input', ()=>{
      if (remember.checked){
        try{ localStorage.setItem('vh_key', key.value.trim()); }catch{}
      }
    });

    let images = [];
    function addThumb(src){ const img=new Image(); img.src=src; img.loading='lazy'; thumbs.appendChild(img); }
    async function filesToDataURLs(list){
      const arr=[]; for (const f of list){
        const url=await new Promise((res,rej)=>{
          const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);
        });
        arr.push(url);
      }
      return arr;
    }

    // Pick from library / camera
    pickBtn.addEventListener('click', ()=>{ file.removeAttribute('capture'); file.click(); });
    cameraBtn.addEventListener('click', ()=>{ file.setAttribute('capture','environment'); file.click(); });
    file.addEventListener('change', async (e)=>{
      const urls=await filesToDataURLs(e.target.files);
      images.push(...urls); urls.forEach(addThumb); file.value='';
    });

    // Clipboard paste
    pasteBtn.addEventListener('click', async ()=>{
      try{
        const items = await navigator.clipboard.read();
        for (const it of items){
          for (const type of it.types){
            if (type.startsWith('image/')){
              const blob = await it.getType(type);
              const url = await new Promise((res)=>{
                const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob);
              });
              images.push(url); addThumb(url);
            }
          }
        }
      }catch{ alert('Clipboard read not supported here.'); }
    });

    function buildInput(){
      const content=[]; const text=promptEl.value.trim();
      if (text) content.push({type:'input_text', text});
      for (const img of images) content.push({type:'input_image', image_url: img});
      return [{role:'user', content}];
    }

    function extractText(resp){
      try{
        const arr=resp.output||[]; let txt='';
        for (const item of arr){
          if (item.type==='message' && item.content){
            for (const c of item.content){
              if (c.type==='output_text' && typeof c.text==='string') txt+=c.text;
              if (c.type==='text' && typeof c.text==='string') txt+=c.text;
            }
          }
          if (item.type==='output_text' && typeof item.text==='string') txt+=item.text;
        }
        return txt.trim()||JSON.stringify(resp,null,2);
      }catch(e){ return JSON.stringify(resp,null,2); }
    }

    async function callAPI(){
      const API_KEY = key.value.trim();
      if (!API_KEY){ alert('Enter your OpenAI API key.'); return; }
      if (images.length===0 && !promptEl.value.trim()){
        alert('Add at least one image or a prompt.'); return;
      }
      runBtn.disabled=true; out.textContent='Asking model...';

      const payload = { model: model.value, input: buildInput() };
      // Include reasoning only when supported and toggled on
      if (!reasoningToggle.disabled && reasoningToggle.checked){
        payload.reasoning = { effort: effort.value };
      }

      try{
        const resp = await fetch('https://api.openai.com/v1/responses',{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':`Bearer ${API_KEY}`},
          body: JSON.stringify(payload)
        });
        if (!resp.ok){
          const t = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${t}`);
        }
        const data = await resp.json();
        out.textContent = extractText(data);
      }catch(err){
        out.innerHTML = `<span class="warn">Error:</span> ${String(err.message||err)}`;
      }finally{
        runBtn.disabled=false;
      }
    }

    runBtn.addEventListener('click', callAPI);
    clearBtn.addEventListener('click', ()=>{
      images=[]; thumbs.innerHTML=''; out.textContent=''; promptEl.value='';
    });
  </script>
</body>
</html>